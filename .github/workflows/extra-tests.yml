name: Extra tests

on:
  pull_request:
    types: [labeled]

jobs:
  windows-hyperv-functional:
    if: contains(github.event.pull_request.labels.*.name, 'ok-to-extra-test')
    runs-on: ubuntu-latest
    env:
      MINIKUBE_AZ_RESOURCE_GROUP: "SIG-CLUSTER-LIFECYCLE-MINIKUBE"
      AZURE_DEFAULTS_LOCATION: "southcentralus"
      MINIKUBE_AZ_SIG_NAME: "minikube"
      MINIKUBE_AZ_IMAGE_NAME: "minikube-ci-windows-11"
      MINIKUBE_AZ_IMAGE_VERSION: "1.0.0"
    steps:
      - name: Azure Login
        id: azlogin
        uses: azure/login@v2
        with:
          creds: '{"clientId":"${{ secrets.MINIKUBE_AZ_CLIENT_ID }}","clientSecret":"${{ secrets.MINIKUBE_AZ_PASSWORD }}","subscriptionId":"${{ secrets.MINIKUBE_AZ_SUBSCRIPTION_ID }}","tenantId":"${{ secrets.MINIKUBE_AZ_TENANT_ID }}"}'
      - uses: actions/checkout@v6
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: 'go.mod'
          cache: true
      - name: Build Windows Binaries
        run: |
          sudo apt-get update &
          make e2e-windows-amd64.exe
          make minikube-windows-amd64.exe
      - name: Install Tools
        run: |
          sudo apt-get install -y sshpass
          go install github.com/medyagh/gopogh/cmd/gopogh@latest
      - name: Create VM
        id: create_vm
        uses: azure/bicep-deploy@v2
        with:
          type: deploymentStack
          operation: create
          name: "${{ github.event.pull_request.number }}-${{ github.run_id }}-stack"
          scope: resourceGroup
          resource-group-name: ${{ env.MINIKUBE_AZ_RESOURCE_GROUP }}
          subscription-id: ${{ secrets.MINIKUBE_AZ_SUBSCRIPTION_ID }}
          template-file: ./hack/windows-ci-image/vm.bicep
          parameters-file: ./hack/windows-ci-image/vm.bicepparam
          parameters: '{"vmName": "m-${{ github.event.pull_request.number }}-${{ github.run_id }}"}'
          action-on-unmanage-resources: delete
          deny-settings-mode: none

      - name: Wait for SSH
        env:
          SSHPASS: ${{ secrets.MINIKUBE_AZ_CI_WINDOWS_VM_PASSWORD }}
        run: |
          VM_NAME="m-${{ github.event.pull_request.number }}-${{ github.run_id }}"
          HOST="${VM_NAME}.${AZURE_DEFAULTS_LOCATION}.cloudapp.azure.com"
          echo "Waiting for SSH on $HOST..."
          for i in {1..30}; do
            if sshpass -e ssh -o StrictHostKeyChecking=no -o PubkeyAuthentication=no -o ConnectTimeout=5 "minikubeadmin@$HOST" "echo 'SSH Ready'"; then
              echo "SSH is ready!"
              exit 0
            fi
            echo "Waiting for SSH... ($i/30)"
            sleep 10
          done
          echo "SSH failed to become ready."
          exit 1

      - name: Copy Binaries to VM
        env:
          SSHPASS: ${{ secrets.MINIKUBE_AZ_CI_WINDOWS_VM_PASSWORD }}
        run: |
          VM_NAME="m-${{ github.event.pull_request.number }}-${{ github.run_id }}"
          HOST="${VM_NAME}.${AZURE_DEFAULTS_LOCATION}.cloudapp.azure.com"
          USER="minikubeadmin"
          
          # Copy binaries
          sshpass -e scp -o StrictHostKeyChecking=no -o PubkeyAuthentication=no ./out/minikube-windows-amd64.exe "$USER@$HOST:C:/Users/$USER/"
          sshpass -e scp -o StrictHostKeyChecking=no -o PubkeyAuthentication=no ./out/e2e-windows-amd64.exe "$USER@$HOST:C:/Users/$USER/"

      - name: Run Functional Test
        continue-on-error: true
        env:
          SSHPASS: ${{ secrets.MINIKUBE_AZ_CI_WINDOWS_VM_PASSWORD }}
          # Pass environment variables needed for gopogh
          SET_PR_NUMBER: ${{ github.event.pull_request.number }}
          COMMIT: ${{ github.sha }}
          ROOT_JOB_ID: ${{ github.run_id }}
          windows_functional_azure: "Windows Functional Azure"
        run: |
          VM_NAME="m-${{ github.event.pull_request.number }}-${{ github.run_id }}"
          HOST="${VM_NAME}.${AZURE_DEFAULTS_LOCATION}.cloudapp.azure.com"
          USER="minikubeadmin"
          
          CMD="
          \$env:Path += ';C:\Users\minikubeadmin\go\bin';
          \$env:SET_PR_NUMBER = '$SET_PR_NUMBER';
          \$env:COMMIT = '$COMMIT';
          \$env:ROOT_JOB_ID = '$ROOT_JOB_ID';
          \$env:windows_functional_azure = '$windows_functional_azure';
          
          gotestsum --jsonfile testout.json -f standard-verbose --raw-command -- \`
            powershell -Command \"./e2e-windows-amd64.exe --minikube-start-args='--driver=hyperv' --binary=./minikube-windows-amd64.exe '-test.run' TestFunctional '-test.v' '-test.timeout=40m' | go tool test2json -t | Tee-Object -FilePath testout.txt\"
          
          \$env:result=\$lastexitcode
          if(\$env:result -eq 0){ echo 'minikube: SUCCESS' } else { echo 'minikube: FAIL' }      
          "
          
          echo "$CMD" > run_tests.ps1
          sshpass -e scp -o StrictHostKeyChecking=no -o PubkeyAuthentication=no run_tests.ps1 "$USER@$HOST:C:/Users/$USER/"
          sshpass -e ssh -o StrictHostKeyChecking=no -o PubkeyAuthentication=no -o ServerAliveInterval=60 -o ServerAliveCountMax=9 "$USER@$HOST" "powershell -File C:/Users/$USER/run_tests.ps1"

      - name: Copy results from inside the VM
        if: always() && steps.azlogin.outcome == 'success'
        env:
          SSHPASS: ${{ secrets.MINIKUBE_AZ_CI_WINDOWS_VM_PASSWORD }}
        run: |
          VM_NAME="m-${{ github.event.pull_request.number }}-${{ github.run_id }}"
          HOST="${VM_NAME}.${AZURE_DEFAULTS_LOCATION}.cloudapp.azure.com"
          USER="minikubeadmin"
          
          sshpass -e scp -o StrictHostKeyChecking=no -o PubkeyAuthentication=no "$USER@$HOST:C:/Users/$USER/testout.json" . || true
          sshpass -e scp -o StrictHostKeyChecking=no -o PubkeyAuthentication=no "$USER@$HOST:C:/Users/$USER/testout.txt" . || true

      - name: Create Report Directory
        if: always() && steps.azlogin.outcome == 'success'
        run: |
          mkdir -p report
          [ -f testout.json ] && mv testout.json report/
          [ -f testout.txt ] && mv testout.txt report/

      - name: Generate Gopogh HTML Report
        if: always() && steps.azlogin.outcome == 'success'
        shell: bash
        env:
          SET_PR_NUMBER: ${{ github.event.pull_request.number }}
          COMMIT: ${{ github.sha }}
          ROOT_JOB_ID: ${{ github.run_id }}
          windows_functional_azure: "Windows Functional Azure"
        run: |
          STAT=$(gopogh -in ./report/testout.json -out_html ./report/testout.html -out_summary ./report/testout_summary.json -name "Windows Functional Azure ${GITHUB_REF}" -repo "${GITHUB_REPOSITORY}"  -details "${GITHUB_SHA}")  || true
          
          PassNum=$(echo $STAT | jq '.NumberOfPass')
          FailNum=$(echo $STAT | jq '.NumberOfFail')
          TestsNum=$(echo $STAT | jq '.NumberOfTests')

          if [ "${FailNum}" -eq 0 ]; then
            STATUS_ICON="âœ“"
          else
            STATUS_ICON="âœ—"
          fi
          if [ "${PassNum}" -eq 0 ]; then
            STATUS_ICON="âœ—"
          fi

          # Result in one sentence
          RESULT_SHORT="${STATUS_ICON} Completed with ${FailNum} / ${TestsNum} failures"

          echo "RESULT_SHORT=${RESULT_SHORT}" >> $GITHUB_ENV
          echo 'STAT<<EOF' >> $GITHUB_ENV
          echo "${STAT}" >> $GITHUB_ENV
          echo 'EOF' >> $GITHUB_ENV

      - name: Set PR or Branch label for report filename
        if: always() && steps.azlogin.outcome == 'success'
        id: vars
        run: |
            if [ "${{ github.event_name }}" = "pull_request" ]; then
              echo "PR_OR_MASTER=PR${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
            else
              echo "PR_OR_MASTER=Master" >> $GITHUB_OUTPUT
            fi
            echo "COMMIT_SHA=${GITHUB_SHA:0:7}" >> $GITHUB_OUTPUT
            RUN_ID_SHORT="$GITHUB_RUN_ID"
            if [ ${#RUN_ID_SHORT} -gt 7 ]; then
              RUN_ID_SHORT="${RUN_ID_SHORT: -7}"
            fi
            echo "RUN_ID_SHORT=${RUN_ID_SHORT}" >> $GITHUB_OUTPUT

      - name: Upload Gopogh report
        if: always() && steps.azlogin.outcome == 'success'
        id: upload_gopogh
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f
        with:
            name: functional-windows-hyperv-${{ steps.vars.outputs.PR_OR_MASTER }}-sha-${{ steps.vars.outputs.COMMIT_SHA }}-run-${{ steps.vars.outputs.RUN_ID_SHORT}}
            path: ./report

      - name: The End Result Summary
        if: always() && steps.azlogin.outcome == 'success'
        shell: bash
        run: |
            summary="$GITHUB_STEP_SUMMARY"
            Print_Gopogh_Artifact_Download_URL() {
              ARTIFACT_NAME="functional-windows-hyperv-${{ steps.vars.outputs.PR_OR_MASTER }}-sha-${{ steps.vars.outputs.COMMIT_SHA }}"
              ARTIFACT_ID='${{ steps.upload_gopogh.outputs.artifact-id }}'
                if [ -n "$ARTIFACT_ID" ]; then
                URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}/artifacts/$ARTIFACT_ID"
                echo "Gopogh report artifact ($ARTIFACT_NAME): $URL"
                echo "ðŸ“¥ [Download Gopogh Report]($URL)" >> "$summary"
              else
                echo "Could not determine artifact ID (action version may not expose it). Find artifact named: $ARTIFACT_NAME"
                echo "Report artifact name: $ARTIFACT_NAME" | tee -a "$summary"
              fi
            }

            Print_Gopogh_Artifact_Download_URL
            echo "-------------------- RESULT SUMMARY --------------------"
            echo "$RESULT_SHORT" | tee -a "$summary"            

            numFail=$(echo "$STAT" | jq -r '.NumberOfFail // 0')
            numPass=$(echo "$STAT" | jq -r '.NumberOfPass // 0')
            numSkip=$(echo "$STAT" | jq -r '.NumberOfSkip // 0')
            
            # Print test counts only if they are non-zero
            print_test_counts_only() {
              if [ -n "${numFail}" ]; then
              echo "Failed: ${numFail}" | tee -a "$summary"
              fi
              if [ -n "${numPass}" ]; then
              echo "Passed: ${numPass}" | tee -a "$summary"
              fi
              if [ -n "${numSkip}" ]; then
              echo "Skipped: ${numSkip}" | tee -a "$summary"
              fi
            }

            print_test_counts_only

            # Prints lits of test names grouped by result status
            print_test_names_by_status() {
              local count="$1" header="$2" sym="$3" field="$4" to_summary="$5"
              (( count > 0 )) || return 0
              local line="------------------------ ${count} ${header} ------------------------"
              if [ "$to_summary" = "yes" ]; then
                echo "$line" | tee -a "$summary"
                jq -r ".${field}[]? | \"  ${sym} \(.)\"" <<<"$STAT" | tee -a "$summary"
              else
                echo "$line"
                jq -r ".${field}[]? | \"  ${sym} \(.)\"" <<<"$STAT"
              fi
            }

            print_test_names_by_status "${numFail:-0}"   "Failed"  "âœ—" "FailedTests"   yes
            print_test_names_by_status "${numPass:-0}"   "Passed"  "âœ“" "PassedTests"   no
            print_test_names_by_status "${numSkip:-0}"   "Skipped" "â€¢" "SkippedTests"  yes
            echo $summary >> $GITHUB_STEP_SUMMARY

      - name: Cleanup VM
        if: always() && steps.azlogin.outcome == 'success'
        uses: azure/bicep-deploy@v2
        with:
          type: deploymentStack
          operation: delete
          name: "${{ github.event.pull_request.number }}-${{ github.run_id }}-stack"
          scope: resourceGroup
          resource-group-name: ${{ env.MINIKUBE_AZ_RESOURCE_GROUP }}
          subscription-id: ${{ secrets.MINIKUBE_AZ_SUBSCRIPTION_ID }}
          template-file: ./hack/windows-ci-image/vm.bicep
          action-on-unmanage-resources: delete
          deny-settings-mode: none

      - name: Verify Cleanup
        if: always() && steps.azlogin.outcome == 'success'
        uses: azure/cli@v2
        with:
          inlineScript: |
            echo "Verifying cleanup..."
            az resource list --resource-group "${{ env.MINIKUBE_AZ_RESOURCE_GROUP }}" --output table
